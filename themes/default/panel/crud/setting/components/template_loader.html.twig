{% block body_javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const valueSelect = document.querySelector('#Setting_value');
            if (valueSelect) {
                valueSelect.addEventListener('change', loadTemplateInfo);
                loadTemplateInfo();
            }
        });

        function loadTemplateInfo() {
            const valueInput = document.querySelector('#Setting_value').tomselect;
            const templateName = valueInput.getValue();
            const endpointUrl = '{{ path('api_get_template_info', { templateName: 'TEMPLATE_NAME'}) }}';

            fetch(endpointUrl.replace('TEMPLATE_NAME', templateName))
                .then(response => response.json())
                .then(data => {
                    const infoCard = createTemplateInfoCard(data);
                    const formGroups = document.querySelectorAll('.form-group');
                    const lastFormGroup = formGroups[formGroups.length - 1];

                    // Remove existing template info
                    document.querySelector('.template-info-card')?.remove();

                    // Insert new template info
                    lastFormGroup.parentNode.insertBefore(infoCard, lastFormGroup.nextSibling);
                });
        }

        function createTemplateInfoCard(data) {
            const card = document.createElement('div');
            card.className = 'template-info-card mt-4';
            card.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Template Information
                        </h5>
                    </div>
                    <div class="card-body">
                        ${createTemplateInfoContent(data)}
                    </div>
                </div>
            `;
            return card;
        }

        function createTemplateInfoContent(data) {
            let content = '<div class="row g-3">';

            for (const [key, value] of Object.entries(data)) {
                // Skip pteroca.crud.setting.template prefix in display
                const displayKey = key.replace('pteroca.crud.setting.template.', '');

                content += `
                    <div class="col-12">
                        <div class="template-info-row">
                            <strong class="text-muted d-block mb-1" style="font-size: 0.875rem; text-transform: uppercase;">
                                ${formatKey(displayKey)}:
                            </strong>
                            <div class="template-info-value">
                                ${formatValue(displayKey, value)}
                            </div>
                        </div>
                    </div>
                `;
            }

            content += '</div>';
            return content;
        }

        function formatKey(key) {
            // Convert snake_case or camelCase to Title Case
            return key
                .replace(/([A-Z])/g, ' $1')
                .replace(/_/g, ' ')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        function extractValuesFromNestedObject(obj) {
            // Extract all values from nested object, ignoring keys
            const values = [];
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'object' && value !== null) {
                    values.push(...extractValuesFromNestedObject(value));
                } else {
                    values.push(value);
                }
            }
            return values;
        }

        function formatValue(key, value) {
            // Handle contexts specially - extract values from nested object
            if (key === 'contexts' && typeof value === 'object' && value !== null) {
                const contexts = extractValuesFromNestedObject(value);
                return contexts.map(context =>
                    `<span class="badge bg-primary me-1">${escapeHtml(String(context))}</span>`
                ).join('');
            }

            // Handle arrays
            if (Array.isArray(value)) {
                return value.map(item =>
                    `<span class="badge bg-secondary me-1">${escapeHtml(String(item))}</span>`
                ).join('');
            }

            // Handle booleans
            if (typeof value === 'boolean') {
                const icon = value
                    ? '<i class="fas fa-check-circle text-success"></i>'
                    : '<i class="fas fa-times-circle text-danger"></i>';
                const text = value ? 'Yes' : 'No';
                return `${icon} <span class="ms-1">${text}</span>`;
            }

            // Handle objects (nested data) - show as key-value pairs
            if (typeof value === 'object' && value !== null) {
                let nestedContent = '<div class="ms-3 mt-2">';
                for (const [nestedKey, nestedValue] of Object.entries(value)) {
                    const cleanKey = nestedKey.replace('pteroca.crud.setting.template.', '');
                    nestedContent += `
                        <div class="mb-2">
                            <strong class="text-muted" style="font-size: 0.875rem;">
                                ${formatKey(cleanKey)}:
                            </strong>
                            <span class="ms-2">${formatValue(cleanKey, nestedValue)}</span>
                        </div>
                    `;
                }
                nestedContent += '</div>';
                return nestedContent;
            }

            // Handle strings and numbers
            return escapeHtml(String(value));
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>

    <style>
        .template-info-card .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }

        .template-info-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .template-info-row {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .template-info-row:last-child {
            border-bottom: none;
        }

        .template-info-value {
            font-size: 0.95rem;
            color: #212529;
        }

        .template-info-value .badge {
            font-size: 0.875rem;
            padding: 0.35em 0.65em;
        }
    </style>
{% endblock %}
